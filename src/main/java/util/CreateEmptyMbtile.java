package util;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import org.locationtech.jts.geom.Coordinate;
import org.locationtech.jts.geom.Envelope;
import org.locationtech.jts.geom.Geometry;
import org.locationtech.jts.geom.MultiPolygon;
import org.locationtech.jts.geom.Point;
import org.locationtech.jts.io.ParseException;
import org.locationtech.jts.io.WKTReader;

public class CreateEmptyMbtile {

	public static void main(String[] args) {
		
		Map<Integer, Integer> levelMaxYSize = new HashMap<Integer, Integer>();
		levelMaxYSize.put(0, 1);
		levelMaxYSize.put(1, 2);
		levelMaxYSize.put(2, 4);
		levelMaxYSize.put(3, 8);
		levelMaxYSize.put(4, 16);
		levelMaxYSize.put(5, 32);
		levelMaxYSize.put(6, 64);
		levelMaxYSize.put(7, 128);
		levelMaxYSize.put(8, 256);
		levelMaxYSize.put(9, 512);
		levelMaxYSize.put(10, 1024);
		levelMaxYSize.put(11, 2048);
		levelMaxYSize.put(12, 4096);
		levelMaxYSize.put(13, 8192);
		levelMaxYSize.put(14, 16384);
		levelMaxYSize.put(15, 32768);
		levelMaxYSize.put(16, 65536);
		levelMaxYSize.put(17, 131072);
		levelMaxYSize.put(18, 262144);
		levelMaxYSize.put(19, 524288);
		levelMaxYSize.put(20, 1048576);
		
		MBTilesUtils mbtile = new MBTilesUtils("M:\\googleMbtiles\\laibin\\laibin_tian_img_1-18.mbtiles");
//		Integer minZoomLevel = 0;
//		Integer maxZoomLevel = 14;
//		String downloadWkt ="MultiPolygon (((108.43188524682175 23.65454733374769702, 108.43926545015817453 23.71604902821793104, 108.43926545015817453 23.71604902821793104, 108.5007671446284121 23.72588929933316848, 108.52536782241651281 23.63486679151722214, 108.6188503980112614 23.52908387702841608, 108.76891453251863595 23.53646408036484416, 108.80827561697958572 23.39870028475151997, 108.78859507474911084 23.23879587912890798, 108.71725310916363583 23.12071262574605512, 108.62869066912649885 23.06659113461224919, 108.48108660239793721 23.07151127016986791, 108.34578287456342593 23.14285323575534292, 108.33348253566937558 23.27323682803223903, 108.27936104453556254 23.39132008141509189, 108.09485596112486405 23.45282177588532591, 108.10715630001891441 23.60534597817150626, 108.17111806226795068 23.69882855376626551, 108.23015968895937533 23.75048997712126209, 108.34332280678461302 23.76279031601530889, 108.43188524682175 23.65454733374769702)))";

		Integer minZoomLevel = 1;
		Integer maxZoomLevel = 18;
//		广西的
		//		String downloadWkt = "MultiPolygon (((106.58767386672170119 22.79550198262848326, 106.3006671013318396 22.75350099257143199, 106.12216289358937615 22.8795039627425858, 105.91565802580888089 22.81650247765701067, 105.63215134292377684 22.8935042927616017, 105.49914820774311863 23.0055069329137396, 105.38714556759097718 23.17701097564669865, 105.38364548508621965 23.28901361579883655, 105.4431468876670408 23.39401609094146295, 105.53064895028590797 23.47801807105556549, 105.68815266299984046 23.52701922612212826, 105.79315513814248106 23.58302054619819543, 105.91215794330412336 23.65302219629328206, 105.98565967590396042 23.79652557898820575, 105.95765901586592861 23.9015280541308357, 105.65665192045705112 23.91902846665460558, 105.34164449502917194 23.91202830164509763, 104.98813616204898835 24.17453448950166717, 104.98813616204898835 24.29353729466331302, 104.6381279115735623 24.21303539705396446, 104.4806241988596156 24.38453943978692351, 104.36862155870748836 24.57354389504365244, 104.38962205373600511 24.78354884532890878, 104.53662551893569344 24.93055231052859, 104.68712906664012507 24.84305024790973349, 105.01963690459177769 25.10205635326154905, 105.34164449502915772 25.08105585823302519, 105.69865291051409883 24.95155280555711741, 105.92965835582788259 24.91655198050957409, 106.33216784387462894 25.2280593234326993, 106.67867601184529747 25.39956336616565835, 106.87468063211153435 25.62706872897468457, 107.27018995514877986 25.76357194666010386, 107.50119540046256361 25.65156930650796951, 107.65869911317651031 25.49056551128927239, 107.78470208334766767 25.37506278863238052, 107.96670637359488865 25.38906311865139642, 108.08570917875653095 25.53956666635583161, 108.3167146240703147 25.64106905899370403, 108.56872056441260099 25.61306839895566867, 108.81722642225015818 25.78457244168863127, 109.07973261010673127 25.89657508184076562, 109.31773822043004429 26.02607813451666985, 109.57674432578185986 26.16608143470683956, 109.79374944107661349 26.23958316730668017, 110.14375769155205376 26.28508423986848541, 110.85077435751242092 26.48458894263948338, 111.22878326802587878 26.44258795258243211, 111.51579003341572616 26.26408374483996511, 111.62429259106311008 26.01207780449765394, 111.65929341611065695 25.72507103910780657, 111.43178805330163073 25.32256155106106377, 111.68379399364394544 24.94455264054760235, 112.2053062868523341 24.89905156798579711, 112.25430744191889687 24.6085447200911922, 112.31730892700447555 24.39853976980593586, 112.18080570931905982 24.02403094179722842, 111.92179960396724425 23.73002401139786954, 111.87979861391019654 23.40101625595096735, 111.61379234354886592 22.90400454027586008, 111.36178640320657962 22.36499183454370154, 111.08177980282624731 22.39999265959124131, 110.90677567758852717 22.08498523416335857, 110.68977056229375933 21.73497698368792896, 110.36776297185636508 21.46897071332660545, 109.98275389633339216 21.39196889822201442, 109.77974911105764022 21.27996625806987652, 109.51024275819155207 21.32196724812693134, 109.20573558027793126 21.23446518550807482, 108.89072815485005208 21.29396658808889597, 108.59672122445068965 21.31496708311742339, 108.05770851871854177 21.35346799066971712, 107.76720167082393687 21.42346964076480376, 107.35419193526293213 21.44097005328857719, 107.13018665495864923 21.52147195089792575, 106.88518087962584957 21.6929759936308848, 106.63667502178830659 21.79447838626875722, 106.41966990649353875 22.08498523416336212, 106.39516932896025025 22.50149505222912083, 106.58767386672170119 22.79550198262848326)))";
//		新疆一个小地方的
//		String downloadWkt = "MultiPolygon (((83.88367720919524118 52.40043562208521166, 77.53275285522974514 49.17535684858710709, 73.06725916884775529 46.19836105766577816, 74.35729067824699712 39.05357115945460578, 76.24272134583050331 35.43155961383365593, 82.09747973464244808 32.6530302089737603, 89.93690198406859793 31.51184848912058101, 94.65047865302736341 32.4545638229123341, 97.92517402304082452 38.40855540475497776, 99.61213830456290452 43.41983165280588253, 100.75332002441608381 47.19069298797289491, 93.01313096802063285 50.8623211301091942, 88.54763728163865721 51.55695348132416456, 88.54763728163865721 51.55695348132416456, 83.88367720919524118 52.40043562208521166)))";
//		柳州的
//		String downloadWkt = "MultiPolygon (((108.63383757300262289 25.66446555215462055, 108.52994572492146119 25.51871061797821127, 108.54148926359715688 25.35539381825374861, 108.56072849472327846 25.16748060344614757, 108.62614188055219699 25.04204390252005652, 108.77620788333611301 25.02112528649033507, 108.89164327009299882 25.05598766468758143, 108.88779542386778587 24.94788206722292756, 108.92627388612004324 24.88157683610609183, 108.84162126916501734 24.74536514735550696, 108.78775142201182291 24.65797133580673162, 108.78005572956134017 24.53201670782486232, 108.78775142201182291 24.40943953788100274, 108.83392557671456302 24.27622088983764925, 108.89549111631822598 24.0901825116487025, 108.9416652710209803 23.99881941394605178, 109.08403558135445621 23.93904689873781066, 109.22255804546267655 23.86165312657368176, 109.449580972751221 23.82997869529185309, 109.61119051421081849 23.88980167603366311, 109.69969097739111419 23.96366246807081524, 109.82666990282365305 24.10774488135529836, 109.96904021315712896 24.16743891427640278, 110.04599713766171476 24.1955205748011295, 110.11525836971584624 24.29025050103262018, 110.18451960176997773 24.37790042192676054, 110.23069375647271784 24.49700684080628932, 110.25378083382410921 24.636987702942033, 110.18067175554475057 24.74187057265322309, 109.91901821222916169 24.85364818762674588, 109.76510436322001851 24.93043677827228066, 109.80743067169750304 25.15354954919318686, 109.84975698017503021 25.42491738857853179, 109.8805397499768759 25.55690168820309083, 109.907474673553466 25.7268775212142522, 109.84590913394981726 25.94160111726160878, 109.71508236229203703 26.08338125556516118, 109.46497235765211542 26.12139067126079794, 109.28027573884114076 25.98657432766773567, 109.28412358506636792 25.8758401437580936, 108.98399157949850746 25.8758401437580936, 108.8454691153902445 25.84121438771860468, 108.83777342293980439 25.67833770517621872, 108.83777342293980439 25.67833770517621872, 108.63383757300262289 25.66446555215462055)))";
//		柳州19-20
//		String downloadWkt = "MultiPolygon (((109.39321233482318974 24.41871148914168543, 109.36013275465624872 24.4095254494971492, 109.33362216913238285 24.3885873269297484, 109.33127609961699989 24.36679090216671639, 109.33151070656853676 24.34798312523102837, 109.33502981084161831 24.31805590383468996, 109.33409138303548502 24.29432287042969918, 109.32564553278010067 24.27165474954327706, 109.30617315580236948 24.26887441848215587, 109.2949120221285142 24.26352745700979341, 109.2939735943223809 24.25433015714282092, 109.31673046862162835 24.25005211657503068, 109.34441408890315017 24.24534610575237892, 109.37139388833013243 24.24898258394874162, 109.39602761824167487 24.2622441527855095, 109.40986942838243579 24.25924972588080308, 109.4483449684348102 24.23935638565617978, 109.48588208068098027 24.24834086005624556, 109.49198186142098166 24.27700136905159312, 109.50136613948251352 24.29881324429168288, 109.50230456728864681 24.32361435082334822, 109.47978229994096466 24.33558556260537387, 109.45632160478709238 24.33815067512707486, 109.44412204330710381 24.37875803191153423, 109.44083754598554492 24.3932880238946197, 109.4319224818270726 24.41123453074485639, 109.42066134815324574 24.41935235067992949, 109.42066134815324574 24.41935235067992949, 109.39321233482318974 24.41871148914168543)))";
//		苍梧
//		String downloadWkt = "MultiPolygon(((110.9368118 23.66725066,110.8580453 23.6163873,110.82257927 23.54176753,110.85327273 23.47455089,110.92072483 23.45032324,110.97229623 23.41869483,111.10754149 23.40393979,111.19294506 23.40535046,111.21787554 23.46252962,111.22413399 23.49970365,111.12425659 23.5325943,111.05419443 23.58928271,111.06068612 23.6149008,111.10948493 23.59939174,111.14896849 23.60125457,111.19434263 23.63348126,111.25504236 23.69691266,111.28751721 23.71240784,111.29645217 23.61914475,111.30840451 23.55001915,111.34112983 23.50704069,111.42283313 23.50694139,111.51153088 23.52387342,111.52150499 23.58644918,111.58384479 23.61537718,111.63806803 23.62132648,111.70425403 23.69290874,111.69681348 23.75294231,111.70828632 23.8503817,111.6921005 23.94440507,111.66155854 23.99363548,111.61699173 24.02512498,111.59928522 24.05198802,111.62580726 24.07882186,111.61620476 24.14477194,111.57541857 24.18241088,111.50629483 24.1883162,111.39589537 24.14981052,111.34348281 24.05002169,111.347037 23.94158481,111.31682161 23.90417161,111.26145079 23.95755079,111.17237629 23.9811613,111.08845031 23.95500424,111.02501165 23.88634273,110.95508613 23.81120545,110.90697266 23.74880947,110.9321068 23.69008159,110.9368118 23.66725066)))";
//		来宾市
		String downloadWkt = "MultiPolygon(((109.39818333943649975 23.96509273378859461, 109.30216242473539978 24.10838548341946819, 109.18250559256941301 24.09361303500391216, 109.04364457746319772 24.15270282866612916, 108.99341825285031859 24.25020098820878545, 108.91512427624788018 24.32406323028655493, 108.7954674440818934 24.41122067593832412, 108.70683275358857145 24.39792547236432796, 108.62558428730302751 24.29747282313855905, 108.62558428730302751 24.21622435685301156, 108.52513163807725505 24.14236211477524208, 108.42763347853460232 24.04190946554947672, 108.36115746066455756 23.89713947107703973, 108.39070235749569804 23.74350600755527907, 108.44092868210857716 23.63418988928017939, 108.50001847577080127 23.60464499244907088, 108.63592500119389683 23.68737070357617114, 108.68910581548988148 23.71987009009039227, 108.71865071232099353 23.63418988928017939, 108.75115009883521111 23.51010132258952368, 108.78955846471565394 23.41260316304686739, 108.88410213457520115 23.31510500350421111, 108.99341825285030438 23.26487867889132843, 109.07614396397740109 23.23828827174333256, 109.18250559256938459 23.21760684396155483, 109.27409477274582628 23.25010623047577596, 109.33909354577426143 23.31510500350421111, 109.41295578785202736 23.30328704477176771, 109.45431864341558992 23.27374214794065921, 109.5104539473946943 23.24419725110955426, 109.55477129264134817 23.23533378206021993, 109.61386108630357228 23.25601520984199766, 109.67590536964890191 23.32101398287043281, 109.75863108077599861 23.36828581780020642, 109.81772087443820851 23.38601275589887152, 109.90340107524842495 23.37714928684953719, 109.9683998482768601 23.4421480598779759, 110.00976270384040845 23.58691805435040578, 110.02748964193908421 23.67259825516061866, 110.11021535306618091 23.75236947660460984, 110.2018045332426226 23.79077784248504912, 110.29043922373594455 23.80555029090060515, 110.37316493486304125 23.82918620836549195, 110.39384636264482253 23.95918375442236581, 110.47066309440569398 24.03009150681702621, 110.51793492933546759 24.15418007350767837, 110.42043676979281486 24.31667700607877336, 110.31407514120083135 24.38463026879032114, 110.24612187848927647 24.47917393864986835, 110.15453269831284899 24.52940026326275103, 110.07180698718573808 24.52940026326275103, 109.98908127605864138 24.41712965530454227, 109.97430882764308535 24.37281231005787774, 109.88862862683286892 24.37281231005787774, 109.81181189507199747 24.34326741322676924, 109.64931496250089538 24.24281476400100388, 109.51931741644402507 24.17190701160634347, 109.43954619500003389 24.06259089333124379, 109.39818333943649975 23.96509273378859461)))";
		
		WKTReader reder = new WKTReader();
		MultiPolygon polygon = null;
		try {
//			层级高的时候，要在这个范围的瓦片才会生成
		  polygon = (MultiPolygon) reder.read(downloadWkt);
		} catch (ParseException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		List<Map<String, Integer>> list = new ArrayList<Map<String,Integer>>();
//		生成几层就循环几次
		for (int i = minZoomLevel; i <= maxZoomLevel; i++) {
//			生成的范围，其实应该用pologon来计算
			Envelope envel = polygon.getEnvelopeInternal();
			
			Coordinate min = TileGrid.lonlat2xy(envel.getMinX(),envel.getMinY(), i);
			Coordinate max = TileGrid.lonlat2xy(envel.getMaxX(),envel.getMaxY(), i);
			int minx =(int) min.getX();
			int miny =(int) min.getY();
		
			
			int maxx = (int) max.getX();
			int  maxy = (int) max.getY();
			
			int tem;
			if(minx>maxx) {
				tem = minx;
				minx = maxx;
				maxx = tem;
			}
			
			if(miny>maxy) {
				tem = miny;
				miny = maxy;
				maxy = tem;
			}
			
//			System.err.println(i+": "+minx+" "+maxx);
//			
//			System.err.println(i+": "+miny+" "+maxy);
			int maxY = levelMaxYSize.get(i);
			
			for (int x = minx-1; x <= maxx+1; x++) {
				for (int y = miny-1; y <= maxy+1; y++) {
					System.err.println(i+": "+x+" "+y);
					Point p = TileGrid.xyz2prj3857(i, x, y);
					System.err.println(p.getX()+" "+p.getY());
					if(i>12&&!polygon.contains(p)) {
						System.err.println("不包含");
						continue;
					}
					int tombtile_tile_row = -(y+1-maxY) ;
					Map<String, Integer> map = new HashMap<String, Integer>();
					map.put("tile_column", x);
					map.put("tile_row", tombtile_tile_row);
					map.put("zoom_level", i);
					list.add(map);
					if(list.size()>=10000) {
						mbtile.insertBatch(mbtile.getConn(),list);
						list.clear();
					}
//					mbtile.insert(mbtile.getConn(), x, tombtile_tile_row, i);
				}
			}
		}
		
		mbtile.insertBatch(mbtile.getConn(),list);
		list.clear();
	}
}
